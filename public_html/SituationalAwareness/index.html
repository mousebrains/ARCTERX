<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
 <link rel="stylesheet" href="css/leaflet.css" />
 <link rel="stylesheet" href="css/leaflet-ruler.css" />
 <link rel="stylesheet" href="css/SitA.css" />
 <script src="js/leaflet.js"></script>
 <script src="js/leaflet-ruler.js"></script>
 <script src="js/SitA.js"></script>
 <title>ARCTERX</title>
</head>
<body style="height: 100%">
<div id="map" style="width: 100%; height: 99%;"></div>
<script>
var gebcoMap = L.tileLayer("https://services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer//tile/{z}/{y}/{x}.png",
	{
		maxZoom: 10,
		attribution: '&copy; GEBCO',
	});
var topoMap = L.tileLayer("https://services.arcgisonline.com/arcgis/rest/services//World_Topo_Map/MapServer/tile/{z}/{y}/{x}.png",
	{
		maxZoom: 19,
		attribution: '&copy; ESRI',
	});

var satMap = L.tileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png",
	{
		maxZoom: 17,
		attribution: '&copy; ESRI',
	});

var eezMap = L.tileLayer.wms("https://gliderwms0.ceoas.oregonstate.edu/geoserver/wms?",
	{
		layers: "ARCTERX:eez_boundaries_v11",
		format: "image/svg",
		transparent: true,
	});


var baseMaps = {
	"GEBCO": gebcoMap,
	"Topo": topoMap,
	"Sattelite": satMap,
};

var overlayMaps = {
	"EEZ": eezMap,
};

var map = L.map("map", {
	center: [7.5150, 134.5825], 
	// zoom: 10,
	zoom: 5,
	layers: [gebcoMap],
});

L.control.mousePosition().addTo(map);

var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

var rulerOptions = {
          lengthUnit: {
            factor: 0.539956803,    //  from km to nm
            display: 'NM',
            decimal: 2
          }
        };
L.control.ruler(rulerOptions).addTo(map);

var colors = {
	Thompson: "red",
	drifter: "blue",
};

var ships = {};
var assets = {};
var openPopups = new Set();

mkPopupText = function(popup) {
	var marker = popup._source;
	var myPos = marker.getLatLng();
	var item = marker.options["item"];
	var t = new Date(item["t"] * 1000);
	var txt = "<center>" + item["key"] + ": " + item["ident"];
	txt += "<br>" + t.toUTCString();
	for (var shp in ships) {
		console.log(shp + " '" + item["key"] + "' '" + item["ident"] + "'");
		var a = ships[shp];
		if ((item["key"] == "ship") && (item["ident"] == a["ident"])) continue;
		var shipPos = a["marker"].getLatLng();
		var dist = myPos.distanceTo(shipPos) / 1852; // Nautical Miles
		var bearing = myPos.bearingTo(shipPos);
		txt += "<br>From " + a["ident"] 
			+ " " + dist.toFixed(2) 
			+ " NM " + bearing.toFixed(0) + " deg true";
	}

	txt += "</center>";

	popup.setContent(txt);
};

map.on("popupopen", function(e) {
	var popup = e.popup;
	openPopups.add(popup);
	mkPopupText(popup);
});

map.on("popupclose", function(e) {
	openPopups.delete(e.popup);
});

const posSource = new EventSource("pos.php");
posSource.onmessage = (event) => {
	var data = JSON.parse(event.data);
	console.log(data);
	for (var key in data) {
		data[key].forEach(function(row) {
			var ident = row["id"];
			var t = row["t"];
			var pos = new L.LatLng(row["lat"], row["lon"]);
			var item = key == "ship" ? ships : assets;
			if (ident in item) {
				item[ident]["t"] = t;
				item[ident]["pos"] = pos;
				item[ident]["marker"].setLatLng(pos);
			} else {
				var color = (ident in colors) ? colors[ident] :
					(key in colors) ? colors[key] : "cadetblue";
				item[ident] = {key: key, ident: ident, t: t, pos: pos};
				item[ident]["marker"] = L.circleMarker(pos, {
					radius: 10,
					opacity: 0.5,
					fillOopacity: 0.5,
					color: color,
					fillColor: color,
					fillOpacity: 0.5,
					item: item[ident],
				});
				item[ident]["marker"].addTo(map).bindPopup(key + ": " + ident,
					{
						closeOnClick: false,
						autoClose: false,
					});
			}
		});
	}
} // onmessage
</script>
</body>
</html>
